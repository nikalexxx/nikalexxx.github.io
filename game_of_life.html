<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <title>c</title>
  <style>
    body {
      padding: 1em;
      margin: 0;
      background-color: #112;
      color: white;
      font-family: sans-serif;
    }

    canvas {
      border: 0 !important;
    }
    input[type=button] {
      background-color: #223;
      color: white;
      font-weight: bold;
      border: 1px solid black;
      border-radius: .5em;
      outline:none;
      width: 5em;
      padding: .5em;
      margin: .5em;
    }
    input[type=button]:hover{
      background-color: #334;
    }

    #cells_new, #cells_old{
      display: inline-block;
      margin: .5em;
      padding: .5em;
      background-color:#08080f;
    }
  </style>

  <style type="text/css">
    canvas {
      border: 1px solid black;
    }
  </style>
</head>

<body onload="game();">
  <canvas id="field"></canvas>
  <p>Поколение <span id="old">0</span></p>
  <p>Популяция <span id="size"></span></p>
  <input type="button" value=">" onclick="stop=!stop;this.value=stop?'>':'||'" id="play">
  <input type="button" value="1>" onclick="one_step()">
  <input type="button" value="X" onclick="clear()" id="btn_clear">
  <br>
  <div id="cells_new">
    <p>Рождение</p>
    <label><input type="checkbox" name="new" id="0">0</label>
    <label><input type="checkbox" name="new" id="1">1</label>
    <label><input type="checkbox" name="new" id="2" checked>2</label>
    <label><input type="checkbox" name="new" id="3" checked>3</label>
    <label><input type="checkbox" name="new" id="4">4</label>
    <label><input type="checkbox" name="new" id="5">5</label>
    <label><input type="checkbox" name="new" id="6">6</label>
    <label><input type="checkbox" name="new" id="7">7</label>
    <label><input type="checkbox" name="new" id="8">8</label>
  </div>
  <br>
  <div id="cells_old">
    <p>Смерть</p>
    <label><input type="checkbox" name="old" id="0">0</label>
    <label><input type="checkbox" name="old" id="1">1</label>
    <label><input type="checkbox" name="old" id="2">2</label>
    <label><input type="checkbox" name="old" id="3" checked>3</label>
    <label><input type="checkbox" name="old" id="4">4</label>
    <label><input type="checkbox" name="old" id="5">5</label>
    <label><input type="checkbox" name="old" id="6">6</label>
    <label><input type="checkbox" name="old" id="7">7</label>
    <label><input type="checkbox" name="old" id="8">8</label>
  </div>
  <script>
    // const H = window.innerHeight;
    // const W = window.innerWidth;
    const H = 200;
    const W = 400;

    var stop = true;
    let torsum = (state, i, j) => {
      // положение строки над текущей клеткой
      i_top_W = (i ? i - 1 : H - 1) * W;
      // положение строки под текущей клеткой
      i_down_W = (H - 1 - i ? i + 1 : 0) * W;
      // положение строки текущей клетки
      i_W = i * W;
      // столбец слева от текущей клетки
      j_l = j ? j - 1 : W - 1;
      // столбец справа от текущей клетки
      j_r = W - 1 - j ? j + 1 : 0;
      return (
        +state[i_top_W + j_l] +
        state[i_top_W + j] +
        state[i_top_W + j_r] +
        state[i_W + j_l] +
        state[i_W + j_r] +
        state[i_down_W + j_l] +
        state[i_down_W + j] +
        state[i_down_W + j_r]
      );
    }

    let state = new Array(H * W);
    let next = new Array(H * W);
    for (let i = 0; i < H * W; i++) {
      state[i] = false;
      next[i] = false;
    }


    function set_life(state, array) {
      for (e of array) {
        state[(e[1] + 50) * W + e[0] + 50] = true;
        next[(e[1] + 50) * W + e[0] + 50] = true;
      }
    }
    let start_state = [
      [3, 0],
      [4, 1],
      [0, 2],
      [4, 2],
      [1, 3],
      [2, 3],
      [3, 3],
      [4, 3],
      [0, 7],
      [1, 8],
      [2, 8],
      [2, 9],
      [2, 10],
      [1, 11],
      [3, 14],
      [4, 15],
      [0, 16],
      [4, 16],
      [1, 17],
      [2, 17],
      [3, 17],
      [4, 17],
    ];
    set_life(state, start_state);

    var img_data, data, ctx;
    var canvas = document.getElementById('field');
    var ctx;
    var rule = {
      new: [],
      old: []
    };

    btn_clear.onclick = clear;

    function game() {
      canvas.width = W;
      canvas.height = H;
      if (canvas.getContext) {
        ctx = canvas.getContext('2d', {
          alpha: false
        });
        img_data = ctx.getImageData(0, 0, W, H);
        data = img_data.data;
        for (let k = 0; k < H * W * 4; k++) {
          data[k] = (k + 1) % 4 == 0 ? 255 : 0;
        }

        paint();
        rules();

        draw();
        life();
      }
    }

    function clear() {
      stop = true;
      for (let k = 0; k < H * W * 4; k++) {
        data[k] = (k + 1) % 4 == 0 ? 255 : 0;
      }
      for (let k = 0; k < H * W; k++) {
        state[k] = (data[k * 4] == 255);
      }
      ctx.putImageData(img_data, 0, 0);
      play.value = ">";
      old.innerHTML = 0;
    }


    function draw() {
      let i, j, k, c;
      k = 0;
      for (k = 0; k < H * W; k++) {
        if (+state[k] !== !data[k * 4 + 1]) {
          data[k * 4] = state[k] ? 255 : 0;
        }
      }
      ctx.putImageData(img_data, 0, 0);
    }

    function step() {
      let i, j, sum, k = 0;
      for (i = 0; i < H; i++) {
        for (j = 0; j < W; j++) {
          sum = torsum(state, i, j);
          if (state[k]) {
            next[k] = rule.new.includes(sum);
          } else {
            next[k] = rule.old.includes(sum);
          }
          k++;
        }
      }
      for (k = 0; k < H * W; k++) {
        state[k] = next[k];
      }
    }
    let i = 0;

    function one_step() {
      step();
      draw();
      i++;
      old.innerHTML = i;
    }

    function life() {
      if (!stop) {
        one_step();
      }
      size.innerHTML = state.reduce((sum, x) => sum += x);
      setTimeout(life, 1);
    }


    function paint() {
      canvas.onmousedown = startDrawing;
      canvas.onmouseup = stopDrawing;
      canvas.onmouseout = stopDrawing;
      canvas.onmousemove = draw;

      let context = ctx;
      let isDrawing;

      context.strokeStyle = 'rgb(255,0,0)';
      context.lineWidth = 1;

      let pause = false;

      function startDrawing(e) {

        // Начинаем рисовать
        isDrawing = true;
        if (!stop) {
          stop = true;
          pause = true;
        }

        // Создаем новый путь (с текущим цветом и толщиной линии) 
        context.beginPath();

        // Нажатием левой кнопки мыши помещаем "кисть" на холст
        context.moveTo(e.pageX - canvas.offsetLeft, e.pageY - canvas.offsetTop);
      }


      function draw(e) {
        if (isDrawing == true) {
          // Определяем текущие координаты указателя мыши
          var x = e.pageX - canvas.offsetLeft;
          var y = e.pageY - canvas.offsetTop;

          // Рисуем линию до новой координаты
          context.lineTo(x, y);
          context.stroke();
        }
      }

      function stopDrawing() {
        isDrawing = false;
        if (pause) {
          stop = false;
          pause = false;
        }


        img_data = ctx.getImageData(0, 0, W, H);
        data = img_data.data;
        for (let k = 0; k < H * W; k++) {
          state[k] = (data[k * 4] == 255);
        }
      }
    }

    function rules() {
      cells_new.addEventListener('click', update_rule);
      cells_old.addEventListener('click', update_rule);

      update(cells_new.querySelector('input'));
      update(cells_old.querySelector('input'));

      function update_rule(e) {
        let elem = e.target;
        if (elem.tagName !== 'INPUT') return;
        update(elem);

      }

      function update(elem) {
        type = elem.name;
        list = elem.closest(`#cells_${type}`).querySelectorAll('input');
        list = Array.from(list).filter(x => x.checked).map(x => +x.id);
        rule[type] = list;
      }
    }
  </script>
</body>

</html>